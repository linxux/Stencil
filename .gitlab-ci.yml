stages:
  - test
  - build
  - release

variables:
  # Binary name
  BINARY_NAME: stencil
  # Build directory
  DIST_DIR: dist

# Test stage
test:go:
  stage: test
  image: golang:latest
  script:
    - go mod download
    - go test -v -race -coverprofile=coverage.out ./...
    - go tool cover -html=coverage.out -o coverage.html
  coverage: '/coverage: \d+\.\d+% of statements/'
  artifacts:
    paths:
      - coverage.out
      - coverage.html
    expire_in: 30 days
  only:
    - merge_requests
    - master
    - main

# Build stage - Build for multiple platforms
build:linux-amd64:
  stage: build
  image: golang:latest
  script:
    - mkdir -p ${DIST_DIR}
    - GOOS=linux GOARCH=amd64 go build -ldflags="-s -w -X 'main.version=${CI_COMMIT_TAG:-dev}' -X 'main.buildTime=${CI_PIPELINE_CREATED_AT}' -X 'main.gitCommit=${CI_COMMIT_SHORT_SHA}'" -o ${DIST_DIR}/${BINARY_NAME}-linux-amd64 ./cmd/stencil/main.go
  artifacts:
    paths:
      - ${DIST_DIR}/${BINARY_NAME}-linux-amd64
    expire_in: 30 days
  only:
    - tags
    - master
    - main

build:linux-arm64:
  stage: build
  image: golang:latest
  script:
    - mkdir -p ${DIST_DIR}
    - GOOS=linux GOARCH=arm64 go build -ldflags="-s -w -X 'main.version=${CI_COMMIT_TAG:-dev}' -X 'main.buildTime=${CI_PIPELINE_CREATED_AT}' -X 'main.gitCommit=${CI_COMMIT_SHORT_SHA}'" -o ${DIST_DIR}/${BINARY_NAME}-linux-arm64 ./cmd/stencil/main.go
  artifacts:
    paths:
      - ${DIST_DIR}/${BINARY_NAME}-linux-arm64
    expire_in: 30 days
  only:
    - tags
    - master
    - main

build:darwin-amd64:
  stage: build
  image: golang:latest
  script:
    - mkdir -p ${DIST_DIR}
    - GOOS=darwin GOARCH=amd64 go build -ldflags="-s -w -X 'main.version=${CI_COMMIT_TAG:-dev}' -X 'main.buildTime=${CI_PIPELINE_CREATED_AT}' -X 'main.gitCommit=${CI_COMMIT_SHORT_SHA}'" -o ${DIST_DIR}/${BINARY_NAME}-darwin-amd64 ./cmd/stencil/main.go
  artifacts:
    paths:
      - ${DIST_DIR}/${BINARY_NAME}-darwin-amd64
    expire_in: 30 days
  only:
    - tags
    - master
    - main

build:darwin-arm64:
  stage: build
  image: golang:latest
  script:
    - mkdir -p ${DIST_DIR}
    - GOOS=darwin GOARCH=arm64 go build -ldflags="-s -w -X 'main.version=${CI_COMMIT_TAG:-dev}' -X 'main.buildTime=${CI_PIPELINE_CREATED_AT}' -X 'main.gitCommit=${CI_COMMIT_SHORT_SHA}'" -o ${DIST_DIR}/${BINARY_NAME}-darwin-arm64 ./cmd/stencil/main.go
  artifacts:
    paths:
      - ${DIST_DIR}/${BINARY_NAME}-darwin-arm64
    expire_in: 30 days
  only:
    - tags
    - master
    - main

build:windows-amd64:
  stage: build
  image: golang:latest
  script:
    - mkdir -p ${DIST_DIR}
    - GOOS=windows GOARCH=amd64 go build -ldflags="-s -w -X 'main.version=${CI_COMMIT_TAG:-dev}' -X 'main.buildTime=${CI_PIPELINE_CREATED_AT}' -X 'main.gitCommit=${CI_COMMIT_SHORT_SHA}'" -o ${DIST_DIR}/${BINARY_NAME}-windows-amd64.exe ./cmd/stencil/main.go
  artifacts:
    paths:
      - ${DIST_DIR}/${BINARY_NAME}-windows-amd64.exe
    expire_in: 30 days
  only:
    - tags
    - master
    - main

# Release stage - Package and create GitLab release
package:release:
  stage: release
  image: alpine:latest
  before_script:
    - apk add --no-cache tar zip bash
  script:
    - mkdir -p ${DIST_DIR}/release

    # Package Linux binaries
    - cd ${DIST_DIR} && tar -czf ${BINARY_NAME}-${CI_COMMIT_TAG}-linux-amd64.tar.gz ${BINARY_NAME}-linux-amd64 && mv ${BINARY_NAME}-${CI_COMMIT_TAG}-linux-amd64.tar.gz release/
    - cd ${DIST_DIR} && tar -czf ${BINARY_NAME}-${CI_COMMIT_TAG}-linux-arm64.tar.gz ${BINARY_NAME}-linux-arm64 && mv ${BINARY_NAME}-${CI_COMMIT_TAG}-linux-arm64.tar.gz release/

    # Package macOS binaries
    - cd ${DIST_DIR} && tar -czf ${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-amd64.tar.gz ${BINARY_NAME}-darwin-amd64 && mv ${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-amd64.tar.gz release/
    - cd ${DIST_DIR} && tar -czf ${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-arm64.tar.gz ${BINARY_NAME}-darwin-arm64 && mv ${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-arm64.tar.gz release/

    # Package Windows binary
    - cd ${DIST_DIR} && zip -r ${BINARY_NAME}-${CI_COMMIT_TAG}-windows-amd64.zip ${BINARY_NAME}-windows-amd64.exe && mv ${BINARY_NAME}-${CI_COMMIT_TAG}-windows-amd64.zip release/

    # Generate checksums
    - cd ${DIST_DIR}/release && sha256sum * > SHA256SUMS.txt

    # Display what was created
    - ls -lh ${DIST_DIR}/release
    - cat ${DIST_DIR}/release/SHA256SUMS.txt
  artifacts:
    paths:
      - ${DIST_DIR}/release/*
    expire_in: 30 days
  only:
    - tags
  needs:
    - build:linux-amd64
    - build:linux-arm64
    - build:darwin-amd64
    - build:darwin-arm64
    - build:windows-amd64

# Create GitLab release
create:release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  script:
    - echo "Creating release for tag ${CI_COMMIT_TAG}"
  release:
    tag_name: $CI_COMMIT_TAG
    name: "Release ${CI_COMMIT_TAG}"
    description: "Stencil ${CI_COMMIT_TAG}\n\n## Changes\nSee [CHANGELOG.md](https://github.com/linxux/stencil/blob/master/CHANGELOG.md) for details.\n\n## Downloads\n\n### Linux\n- **amd64**: [${BINARY_NAME}-${CI_COMMIT_TAG}-linux-amd64.tar.gz](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-linux-amd64.tar.gz)\n- **arm64**: [${BINARY_NAME}-${CI_COMMIT_TAG}-linux-arm64.tar.gz](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-linux-arm64.tar.gz)\n\n### macOS\n- **Intel (amd64)**: [${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-amd64.tar.gz](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-amd64.tar.gz)\n- **Apple Silicon (arm64)**: [${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-arm64.tar.gz](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-arm64.tar.gz)\n\n### Windows\n- **amd64**: [${BINARY_NAME}-${CI_COMMIT_TAG}-windows-amd64.zip](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-windows-amd64.zip)\n\n### Checksums\n- [SHA256SUMS.txt](https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/SHA256SUMS.txt)\n\n## Verification\n\n```bash\n# Download and verify checksums\ncurl -sL https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/raw/dist/release/SHA256SUMS.txt -o SHA256SUMS.txt\nsha256sum -c --ignore-missing SHA256SUMS.txt\n```"
    assets:
      links:
        - name: Linux amd64
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-linux-amd64.tar.gz
          link_type: package
        - name: Linux arm64
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-linux-arm64.tar.gz
          link_type: package
        - name: macOS Intel (amd64)
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-amd64.tar.gz
          link_type: package
        - name: macOS Apple Silicon (arm64)
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-darwin-arm64.tar.gz
          link_type: package
        - name: Windows amd64
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/${BINARY_NAME}-${CI_COMMIT_TAG}-windows-amd64.zip
          link_type: package
        - name: SHA256 Checksums
          url: https://${CI_PROJECT_URL}/-/jobs/${CI_JOB_ID}/artifacts/file/dist/release/SHA256SUMS.txt
          link_type: other
  only:
    - tags
  needs:
    - package:release
